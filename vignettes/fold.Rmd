---
title: "Tutorial: Ratios of continuous variables"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Tutorial: Ratios of continuous variables}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Ratios of continuous outcomes

This vignette shows how `table2()` can be used to calculate ratios of a continuous outcome when comparing two or more groups. These are sometimes called "fold change," which could be mistaken to imply a before-after comparison.

This tutorial illustrates one of many functions of `table2()`.


## Example

The example uses a rather silly data set of historical cars. To compare various features of these cars based on their number of gears, first recode the categorical variable `gear`:

```{r setup}
library(khsmisc)
library(dplyr)
data(mtcars)

cars <- mtcars %>%
  as_tibble(rownames = "make") %>%
  mutate(
    gear_cat = factor(
      gear, 
      levels = 3:5,
      labels = c("Three", "Four", "Five"))) %>%
  select(make, gear, gear_cat, mpg, hp, wt) %>%
  labelled::set_variable_labels(gear_cat = "Gears")

cars
```


Using `table2()`, one can calculate mean differences (`type = "diff"`) in `mpg`, `hp`, or `wt`:

```{r table2_diff}
tribble(
  ~label,                ~outcome, ~type,
  "Miles per gallon",    "mpg",    "mean",
  "  Difference",        "mpg",    "diff",
  "Horsepower",          "hp",     "mean",
  "  Difference",        "hp",     "diff",
  "Weight, in 1000 lbs", "wt",     "mean",
  "  Difference",        "wt",     "diff") %>%
  mutate(
    exposure = "gear_cat") %>%
  table2(data = cars)
```


## Ratios

Two types of ratios for continuous outcomes are implemented in `table2()`:

`type =` | Ratio of ... | Model           | Use
-------|------------|-----------------|-------------------------------------
`"fold"` | Arithmetric means | Generalized linear model with Gaussian distribution and log link: `glm(y ~ x, family = gaussian(link = "log"))` | Tolerates `0` in the `outcome` variable. Best fit if outcome is normally distributed without transformation.
`"irrrob"` | Arithmetric means | Generalized linear model with Poisson distribution and log link: `glm(y ~ x, family = poisson())`, with robust (sandwich) standard errors | Tolerates `0` in the `outcome` variable. (Note, the `stats::glm()` will issue warnings that the outcome is "non-integer." This warning can be ignored here.)
`"foldlog"` | Geometric means | Linear model with log-transformed outcome: `lm(log(y) ~ x)` | Does not tolerate `0` in the `outcome` variable, as `log(0)` is undefined (R returns `-Inf`). Best fit if outcome is normally distributed after log transformation.

In all models, beta coefficients can be interpreted as ratios after exponentiation. `table2()` automatically does all nessary transformations.

In the `cars` data, ratios of usual (arithmetric) means could be considered informative, given that `hist(cars$mpg)` etc. does not show major skew in these outcomes.

```{r table2_ratio}
tribble(
  ~label,                ~outcome, ~type,
  "Miles per gallon",    "mpg",    "mean",
  "  Ratio",             "mpg",    "fold",
  "Horsepower",          "hp",     "mean",
  "  Ratio",             "hp",     "fold",
  "Weight, in 1000 lbs", "wt",     "mean",
  "  Ratio",             "wt",     "fold") %>%
  mutate(
    exposure = "gear_cat") %>%
  table2(data = cars)
```

For example, cars with four gears, compared to three gears, have a 0.67-fold (or 33%) lower weight (95% CI: 0.55, 0.81).


## Formatted tables

To obtain the same results in a formatted table, one can use `gt::gt()` or its wrapper `mygt()` in khsmisc that also does some formatting. The example also adds a linear trend term per additional gear, using the continuous `gear` variable, and sets a different level of precision for the `mean`s, using the `diff_digits` argument:


```{r table2_format}
tribble(
  ~label,                ~outcome, ~type,
  "Miles per gallon",    "mpg",    "mean",
  "  Ratio",             "mpg",    "fold",
  "Horsepower",          "hp",     "mean",
  "  Ratio",             "hp",     "fold",
  "Weight, in 1000 lbs", "wt",     "mean",
  "  Ratio",             "wt",     "fold") %>%
  mutate(
    exposure = "gear_cat",
    trend = "gear") %>%
  table2(data = cars, 
         diff_digits = 1) %>%
  rename(`Per additional gear` = Trend) %>%
  mygt()
```
